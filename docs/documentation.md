## Задачи проекта
1. Сгенерировать "сырые" JSON-файлы с кредитами, информацией о клиентах и историей проведения операций по кредитам.
2. Реализовать ETL-процесс: загрузка, очистка, расчет просрочек.
3. Проанализировать зависимости просрочек от признаков клиента.
4. Построить BI-отчёт: доля просрочек по месяцам, фильтры по сумме.
5. Разработать рекомендации по уведомлению клиентов и управлению рисками.
6. Документировать архитектуру, тестовые кейсы, бизнес-логику.

---

## Бизнес-требования

- Использовать текущую дату (или задаваемую вручную) для расчета просрочек.
- Возможность фильтрации клиентов по сумме кредита:
  - до 50 тыс.
  - 50–100 тыс.
  - 100–500 тыс.
  - более 500 тыс.
- Отчёт в BI должен быть визуализирован (Jupyter/Power BI/Tableau — по выбору).
- Исходные данные — в формате JSON, структура расширяема.

---

## Функциональные требования

- Обработка JSON-файлов с данными клиентов и кредитов.
- Расчёт поля "просрочен/не просрочен" по сроку кредита.
- Загрузка обработанных данных в таблицы DWH.
- Подсчёт % просрочек по месяцам.
- BI-дашборд с фильтрацией по сумме кредита.

---

## Нефункциональные требования

- Репозиторий оформлен с документацией, диаграммами, gif и фото материалами, инструкцией по запуску.
- Возможность масштабирования (поддержка большого объёма JSON).
- Читаемый код и модульная архитектура.
- Инкрементная загрузка данных в DWH.

---

## Ограничения

- Используем синтетические данные (не настоящие банковские), по которым формируются JSON файлы.
- Нет подключения к реальному хранилищу или API (всё локально).


# Описание информационной системы

Информационная система предназначена для анализа кредитной активности клиентов на основе предоставленных банком данных в формате JSON. Система обеспечивает полный цикл обработки данных:

## 1. Загрузка данных
Система позволяет инкрементально загружать данные из JSON-файлов, содержащих информацию о клиентах, кредитах и платежах. Загрузка осуществляется в промежуточный слой хранилища данных (staging), обеспечивая гибкость и контроль при работе с частями данных.

## 2. Очистка и трансформация данных
После загрузки данные проходят трансформацию и обогащение в core-слое. В частности, система вычисляет статус просроченности кредита, сравнивая дату фактического платежа с ожидаемой датой платежа, а также фактически произведенную оплату задолженности с ожидаемой ежемесячной. 
Каждому платежу присваивается флаг status, отражающий факт просрочки.

## 3. Формирование витрины данных (data mart)
На основе трансформированных данных формируется витрина в схеме mart, включающая в себя полную информацию по кредитам, клиентам и платежам. Историчность данных обеспечивается за счёт инкрементального пополнения витрины, без перезаписи ранее загруженных данных.

## 4. BI-аналитика и дашборды
Система поддерживает визуализацию ключевых метрик через BI-инструмент - Power BI. Реализован дашборд, отображающий:

- График доли просроченных кредитов по месяцам;
- Суммарную задолженность по просрочкам за рассматриваемый период;
- Общую сумму кредитов за рассматриваемый период;
- Количество кредитов за рассматриваемый период;
- Количество просроченных кредитов за рассматриваемый период;
- Фильтрацию по сумме кредита;
- Сводку клиентов, просрочивших кредиты.

# Описание структуры DWH

## 1. Слой staging

На данном слое хранятся «сырые» данные, как они пришли из JSON. Здесь сохраняются исходные значения + формируются дополнительные служебные поля file_name и load_ts для контроля инкрементальных загрузок.

ER-диаграмма слоя staging (реализовано через сервис dbdiagram.io)

![image](https://github.com/user-attachments/assets/93b44e73-ef4d-4083-8acb-5f5bcb09e0c5)

### Таблица: clients

Описание: содержит данные о клиентах банка.

| Поле               | Тип данных       | Ограничения                            | Описание                               |
|--------------------|------------------|----------------------------------------|----------------------------------------|
| `client_id`        | INTEGER          | PRIMARY KEY                            | Уникальный идентификатор клиента       |
| `fio`              | TEXT             | NOT NULL                               | ФИО клиента                            |
| `passport`         | TEXT             | NOT NULL, UNIQUE                       | Паспортные данные клиента              |
| `gender`           | gender_enum      | NOT NULL                               | Пол клиента (Мужчина/Женщина)          |
| `birth_date`       | DATE             | NOT NULL                               | Дата рождения                          |
| `education`        | education_enum   | NOT NULL                               | Уровень образования                    |
| `count_of_children`| SMALLINT         |                                        | Количество детей                       |
| `job_type`         | employment_enum  | NOT NULL                               | Тип занятости                          |
| `region`           | TEXT             |                                        | Регион проживания                      |
| `family_status`    | marital_enum     |                                        | Семейное положение                     |
| `address`          | TEXT             |                                        | Адрес клиента                          |
| `phone`            | TEXT             |                                        | Телефон клиента                        |
| `income`           | INTEGER          | NOT NULL                               | Ежемесячный доход                      |
| `file_name`        | TEXT             | NOT NULL                               | Имя файла-источника                    |
| `load_ts`          | TIMESTAMP        | NOT NULL                               | Время загрузки записи                  |

**Примечание:** поля `file_name` и `load_ts` присутствуют только в схеме `staging` и удаляются при переносе в `core`.

Для удобства все ENUM‐типы (пол, образование, занятость, семейный статус) создаются глобально один раз и используются во всех слоях:

- gender_enum: хранит строки 'Мужчина','Женщина';
- education_enum: хранит строки 'Начальное','Среднее','Высшее','Два высших';
- employment_enum: хранит строки 'Безработный','ИП','Самозанятый','Работает по найму';
- marital_enum: хранит строки 'В браке','Не в браке'.


### Таблица: loans

Описание: содержит данные об имеющихся кредитах клиентов.

| Поле              | Тип данных   | Ограничения                                 | Описание                                                      |
|-------------------|--------------|---------------------------------------------|---------------------------------------------------------------|
| `id`              | SERIAL       | PRIMARY KEY                                 | Уникальный идентификатор записи кредита                       |
| `client_id`       | INTEGER      | NOT NULL, FOREIGN KEY → staging.clients     | Идентификатор клиента                                         |
| `loan_name`       | TEXT         | NOT NULL                                    | Название/тип кредита                                          |
| `loan_amount`     | INTEGER      | NOT NULL                                    | Сумма кредита в рублях                                        |
| `loan_start_date` | TIMESTAMP    | NOT NULL                                    | Дата начала действия кредита                                  |
| `loan_end_date`   | TIMESTAMP    | NOT NULL                                    | Дата окончания действия кредита                               |
| `payment_numbers` | SMALLINT     | NOT NULL                                    | Общее количество платежей по кредиту                          |
| `paid_amount`     | INTEGER      | NOT NULL                                    | Сумма, которую клиент должен выплатить                        |
| `file_name`       | TEXT         | NOT NULL                                    | Имя файла-источника данных (техническое поле)                 |
| `load_ts`         | TIMESTAMP    | NOT NULL                                    | Временная метка загрузки (техническое поле)                   |
| `uq_loans_client` | —            | UNIQUE (client_id, loan_name)               | Уникальность кредита по клиенту                               |

**Примечание:** поля `file_name` и `load_ts` присутствуют только в схеме `staging` и удаляются при переносе в `core`.


### Таблица: payments

Описание: содержит данные о фактических транзакциях клиентов по кредитам.

| Поле               | Тип данных   | Ограничения                                                  | Описание                                                      |
|--------------------|--------------|--------------------------------------------------------------|---------------------------------------------------------------|
| `id`               | SERIAL       | PRIMARY KEY                                                  | Уникальный идентификатор записи платежа                       |
| `client_id`        | INTEGER      | NOT NULL, FOREIGN KEY → staging.clients                      | Идентификатор клиента                                         |
| `loan_name`        | TEXT         | NOT NULL, FOREIGN KEY → staging.loans (client_id, loan_name) | Название кредита, к которому относится платёж                 |
| `payment_number`   | SMALLINT     | NOT NULL                                                    | Номер платежа по кредиту                                      |
| `payment_date`     | TIMESTAMP    | NOT NULL                                                    | Плановая дата платежа                                         |
| `payment_fact_date`| TIMESTAMP    | NOT NULL                                                    | Фактическая дата платежа                                      |
| `paid_fact_amount` | INTEGER      | NOT NULL                                                    | Фактически уплаченная сумма                                   |
| `file_name`        | TEXT         | NOT NULL                                                    | Имя файла-источника данных (техническое поле)                 |
| `load_ts`          | TIMESTAMP    | NOT NULL                                                    | Временная метка загрузки (техническое поле)                   |
| `uq_payments_client` | —          | UNIQUE (client_id, loan_name, payment_number)               | Уникальность платежа по клиенту и кредиту                     |

**Примечание:** поля `file_name` и `load_ts` присутствуют только в схеме `staging` и удаляются при переносе в `core`.


## 2. Слой core

Задача core-слоя:
- «Очистить» данные от служебных полей `file_name`, `load_ts` (они нужны только в staging);
- Добавить вычисляемое поле `status` в `core.payments`, которое указывает: была ли просрочка (если payment_fact_date > payment_date или paid_fact_amount < core.payments.paid_amount).

ER-диаграмма слоя core (реализовано через сервис dbdiagram.io)

![image](https://github.com/user-attachments/assets/6046b936-4bdb-4781-ae78-9a7c04186073)

#### Заполнение данными

ETL-механизм автоматически выполняет заполнение данными из слоя core посредством исполнения SQL-скриптов типа UPSERT. 
Исполняемые файлы находятся в папке database/scripts/DML comands.


## 3. Слой mart (витрина данных)

Цель mart-слоя:
- Сформировать «плоскую» таблицу, содержащую объединённые данные по каждому платёжному событию, пригодную напрямую для BI/отчетов;
- Оставить только необходимые поля (включая вычисленное status), все вместе на уровне «каждый платеж → клиент → кредит».


### Таблица: data_mart

| Поле               | Тип данных        | Ограничения                              | Описание                                                        |
|--------------------|-------------------|------------------------------------------|-----------------------------------------------------------------|
| `client_id`        | INTEGER           | NOT NULL, PRIMARY KEY (в составе составного ключа) | Уникальный идентификатор клиента                     |
| `fio`              | TEXT              | NOT NULL                                 | ФИО клиента                                                     |
| `passport`         | TEXT              | NOT NULL                                 | Паспорт клиента                                                 |
| `gender`           | TEXT              | NOT NULL                                 | Пол клиента (Мужчина/Женщина)                                  |
| `birth_date`       | DATE              | NOT NULL                                 | Дата рождения клиента                                           |
| `education`        | TEXT              | NOT NULL                                 | Уровень образования клиента                                     |
| `count_of_children`| SMALLINT          | —                                        | Количество детей у клиента                                      |
| `job_type`         | TEXT              | NOT NULL                                 | Тип занятости (например, Работает по найму, ИП и т.д.)         |
| `region`           | TEXT              | —                                        | Регион проживания клиента                                       |
| `family_status`    | TEXT              | —                                        | Семейное положение клиента                                      |
| `income`           | INTEGER           | NOT NULL                                 | Доход клиента в рублях                                          |
| `loan_name`        | TEXT              | NOT NULL                                 | Название кредита                                                |
| `loan_amount`      | INTEGER           | NOT NULL                                 | Сумма кредита                                                   |
| `loan_start_date`  | TIMESTAMP         | NOT NULL                                 | Дата начала действия кредита                                    |
| `loan_end_date`    | TIMESTAMP         | NOT NULL                                 | Дата окончания действия кредита                                 |
| `paid_amount`      | INTEGER           | NOT NULL                                 | Плановая сумма к погашению по кредиту                          |
| `payment_number`   | SMALLINT          | NOT NULL, PRIMARY KEY (в составе составного ключа) | Номер платежа по графику                         |
| `payment_date`     | TIMESTAMP         | NOT NULL                                 | Плановая дата платежа                                           |
| `payment_fact_date`| TIMESTAMP         | NOT NULL                                 | Фактическая дата платежа                                        |
| `paid_fact_amount` | INTEGER           | NOT NULL                                 | Фактически оплаченная сумма                                     |
| `status`           | BOOLEAN           | NOT NULL                                 | Просрочен ли платёж (TRUE — есть просрочка, FALSE — нет)        |

**Составной первичный ключ:** (`client_id`, `loan_name`, `payment_number`) — обеспечивает уникальность строки по клиенту, кредиту и номеру платежа.

В качестве типа данных для полей gender, education, job_type, family_status используется тип данных TEXT, чтобы упростить работу в BI (не всегда поддерживаются ENUM)

Дополнительно на данном слое создается представление (VIEW) для автоматической загрузки в него данных с таблицы data_mart, а также необходимое для представления в PowerBI агрегированной информации.

# Поток данных (ETL)
Исполнив команду `python main.py load --part N`, где N - номер загружаемой порции данных, поток данных проходит через следующие процессы:
- чтение JSON файлов, перевод их в DataFrame;
- методом `incremental_load` класса DBExtractor (работа с БД) происходит:
  - 1. Создание временной таблицы в БД (исполнение соответствующего DDL скрипта в папке database/scripts/DDL comands);
  - 2. UPSERT загрузка с временной таблицы в физическую.
- перенос всех загруженных данных: staging (clients, loans, payments) -> core (clients, loans, payments) -> mart (data_mart).
  
После завершения данного процесса можно продолжить загружать следующую порцию данных тем самым обеспечивая инкрементную загрузку данных.
















